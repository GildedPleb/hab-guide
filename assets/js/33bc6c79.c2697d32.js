"use strict";(self.webpackChunkhab_guide=self.webpackChunkhab_guide||[]).push([[4137],{3905:(e,t,n)=>{n.d(t,{Zo:()=>h,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var r=a.createContext({}),p=function(e){var t=a.useContext(r),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},h=function(e){var t=p(e.components);return a.createElement(r.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,l=e.originalType,r=e.parentName,h=o(e,["components","mdxType","originalType","parentName"]),d=p(n),c=i,m=d["".concat(r,".").concat(c)]||d[c]||u[c]||l;return n?a.createElement(m,s(s({ref:t},h),{},{components:n})):a.createElement(m,s({ref:t},h))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var l=n.length,s=new Array(l);s[0]=c;var o={};for(var r in t)hasOwnProperty.call(t,r)&&(o[r]=t[r]);o.originalType=e,o[d]="string"==typeof e?e:i,s[1]=o;for(var p=2;p<l;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},7223:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>r,contentTitle:()=>s,default:()=>d,frontMatter:()=>l,metadata:()=>o,toc:()=>p});var a=n(7462),i=(n(7294),n(3905));const l={sidebar_position:12},s="Stand-up Live Hosts",o={unversionedId:"l1-hosts/live-hosts",id:"l1-hosts/live-hosts",title:"Stand-up Live Hosts",description:"Create a Host Plan",source:"@site/docs/l1-hosts/live-hosts.md",sourceDirName:"l1-hosts",slug:"/l1-hosts/live-hosts",permalink:"/hab-guide/docs/l1-hosts/live-hosts",draft:!1,editUrl:"https://github.com/GildedPleb/hab-guide/edit/master/website/docs/l1-hosts/live-hosts.md",tags:[],version:"current",lastUpdatedBy:"GildedPleb",lastUpdatedAt:1672685651,formattedLastUpdatedAt:"Jan 2, 2023",sidebarPosition:12,frontMatter:{sidebar_position:12},sidebar:"tutorialSidebar",previous:{title:"Ansible Vault",permalink:"/hab-guide/docs/l1-hosts/ansible-vault"},next:{title:"Tear-down Live Hosts",permalink:"/hab-guide/docs/l1-hosts/fin"}},r={},p=[{value:"Create a Host Plan",id:"create-a-host-plan",level:2},{value:"Create A Plan From The Plan Template",id:"create-a-plan-from-the-plan-template",level:3},{value:"Edit the New Plan",id:"edit-the-new-plan",level:3},{value:"Stand Up Live Hosts",id:"stand-up-live-hosts-1",level:2},{value:"What Does This Script Do?",id:"what-does-this-script-do",level:3},{value:"Hosts Are Golden",id:"hosts-are-golden",level:2}],h={toc:p};function d(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"stand-up-live-hosts"},"Stand-up Live Hosts"),(0,i.kt)("h2",{id:"create-a-host-plan"},"Create a Host Plan"),(0,i.kt)("p",null,"Before we can stand up live hosts, we need to organize our machines to declare\nwho is who in the cluster."),(0,i.kt)("h3",{id:"create-a-plan-from-the-plan-template"},"Create A Plan From The Plan Template"),(0,i.kt)("p",null,"If you have never created a plan before, run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"awk 'NR>=6' ~/.HAB/inventory/host-plan.tpl > ~/.HAB/inventory/host-plan-$(date \"+%Y-%m-%d\")\n")),(0,i.kt)("p",null,"Let's look at what this does:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"awk")," is a text manipulation tool."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"'NR>=6'")," means to take all the lines in a file that are after the 5th line."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},">")," means take those lines from the file ",(0,i.kt)("inlineCode",{parentName:"li"},"host-plan.tpl")," and write them to the\nfile ",(0,i.kt)("inlineCode",{parentName:"li"},'host-plan-$(date "+%Y-%m-%d")'),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},'$(date "+%Y-%m-%d")')," formats the date year-month-day and appends it to the\nfile name.")),(0,i.kt)("admonition",{type:"info"},(0,i.kt)("p",{parentName:"admonition"},"If you run this command twice in one day it will reset and overwrite any work\nyou have done in the output file\u2014it's not idempotent\u2014you might consider altering\nthe output file name.")),(0,i.kt)("p",null,"You only need to run that command when your vanilla inventory has changed, you\ncan edit or rename any previously existing host-plans at any time\u2014just refrain\nfrom changing the inline definitions at this stage. As in, move the host lines\naround, but don't change the content of those lines."),(0,i.kt)("h3",{id:"edit-the-new-plan"},"Edit the New Plan"),(0,i.kt)("p",null,"We are now going to decide the rolls that each host has."),(0,i.kt)("p",null,"In ",(0,i.kt)("inlineCode",{parentName:"p"},"~/.HAB/inventory/host-plan-{inserted-date}")," (or whatever file name you\nchose), manually move all your hosts by name. Ansible will use this definition\nto create a host list, validate it, and build our cluster according to plan."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Some guidelines:")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Move each hosts to under either ",(0,i.kt)("inlineCode",{parentName:"li"},"leader"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"lieutenants"),", or ",(0,i.kt)("inlineCode",{parentName:"li"},"workers")," and\nremove the ",(0,i.kt)("inlineCode",{parentName:"li"},"#")," before the line"),(0,i.kt)("li",{parentName:"ul"},"There can only be one leader. But the title 'leader' is merely semantic for\nthis guide as that will be the host that will start the HA process first. All\nmaster hosts will be server hosts in an HA quorum."),(0,i.kt)("li",{parentName:"ul"},"Total master hosts (",(0,i.kt)("inlineCode",{parentName:"li"},"leader")," + ",(0,i.kt)("inlineCode",{parentName:"li"},"lieutenants"),") here must be odd and must be 3\nor more."),(0,i.kt)("li",{parentName:"ul"},"Worker hosts are all other hosts and can be 0 total hosts."),(0,i.kt)("li",{parentName:"ul"},"You do not have to activate all hosts: Only removing the ",(0,i.kt)("inlineCode",{parentName:"li"},"#")," and placing the\nhost will activate a host.")),(0,i.kt)("p",null,"Don't worry, Ansible will also validate the plan to make sure you didn't miss\nanything."),(0,i.kt)("p",null,"Example of a valid plan:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini",metastring:'title="~/.HAB/inventory/host-plan-2022-03-17"',title:'"~/.HAB/inventory/host-plan-2022-03-17"'},"# Assign your vanilla hosts to the roles that you would like them to have by  #\n# ... giant block of commented text removed for sanity ...\n#                   -*- End Of Unassigned Inventory -*-                       #\n\n[leader]\nnuc1 ansible_user=ubuntu ansible_ssh_pass=ubuntuRaw mac=1c:69:xx:xx:xx:xx\n\n[lieutenants]\npi1 ansible_user=pi ansible_ssh_pass=raspberryRaw mac=dc:a6:xx:xx:xx:xx\npi2 ansible_user=pi ansible_ssh_pass=raspberryRaw mac=dc:a6:xx:xx:xx:xx\n\n[workers]\nnuc2 ansible_user=ubuntu ansible_ssh_pass=ubuntuRaw mac=1c:69:xx:xx:xx:xx\npi3 ansible_user=pi ansible_ssh_pass=raspberryRaw mac=dc:a6:xx:xx:xx:xx\npi4 ansible_user=pi ansible_ssh_pass=raspberryRaw mac=dc:a6:xx:xx:xx:xx\npi5 ansible_user=pi ansible_ssh_pass=raspberryRaw mac=dc:a6:xx:xx:xx:xx\n")),(0,i.kt)("p",null,"At this point, all the heavy lifting with regard to hardware is done. Running\nthe next ",(0,i.kt)("inlineCode",{parentName:"p"},"standup")," Ansible command, will stand up live hosts, which is to say,\nit will be ready to stand up a vanilla k3s instance."),(0,i.kt)("h2",{id:"stand-up-live-hosts-1"},"Stand Up Live Hosts"),(0,i.kt)("p",null,"Finally, review and then run this script, replace ",(0,i.kt)("inlineCode",{parentName:"p"},"host-plan-2022-03-17")," with\nyour host plan name:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'apb Hosts/standup-live.yml -e "plan=host-plan-2022-03-17"\n')),(0,i.kt)("h3",{id:"what-does-this-script-do"},"What Does This Script Do?"),(0,i.kt)("p",null,"Let's look at what this has given us:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},'We now have new users which are mapped to the role the host has: e.g.\n"worker" on "pi3". Ansible will be using these users from here on out to\nperform k3s functions.')),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"We can now ssh into each host using the right role that host has with our SSH\nkeys, e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"ssh worker@pi3"),", try it, you should get right in:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"ssh leader@nuc1\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"In case of SSH keys being destroyed (it has happened to us) we also have a\nbackup way of getting SSH access to the hosts via password entry. Those\npasswords are encrypted in our ansible-vault which you can view with"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"ansible-vault view ~/.HAB/vault-hosts\n")),(0,i.kt)("p",{parentName:"li"},"Just keep in mind this will print your passwords to the terminal, which is\nill-advised, you might want to use this instead, and just don't edit\nanything."),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"ansible-vault edit ~/.HAB/vault-hosts\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"We have locked out all other accounts, including the raw account user so no\none but the named role account now has access to the host, and they need the\nssh keys or the encrypted password."))),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"We could also lock down all unneeded connections via ",(0,i.kt)("inlineCode",{parentName:"p"},"ufw")," but because we are\nassuming we are behind a heavy gateway firewall, we don't really need it, as at\nthat point it would mean local machines are p0wned which may indicate a far\nbigger problem, like an attacker having physical access.")),(0,i.kt)("h2",{id:"hosts-are-golden"},"Hosts Are Golden"),(0,i.kt)("p",null,"We how have live hosts \ud83d\ude4c"),(0,i.kt)("p",null,"Before we can move on to getting k3s set up, we need to review how to take down\na host. Let's do that now."))}d.isMDXComponent=!0}}]);