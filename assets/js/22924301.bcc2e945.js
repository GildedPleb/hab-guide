"use strict";(self.webpackChunkhab_guide=self.webpackChunkhab_guide||[]).push([[5717],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>m});var a=t(7294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function r(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=a.createContext({}),u=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=u(e.components);return a.createElement(s.Provider,{value:n},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,l=e.originalType,s=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),d=u(t),h=o,m=d["".concat(s,".").concat(h)]||d[h]||c[h]||l;return t?a.createElement(m,i(i({ref:n},p),{},{components:t})):a.createElement(m,i({ref:n},p))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var l=t.length,i=new Array(l);i[0]=h;var r={};for(var s in n)hasOwnProperty.call(n,s)&&(r[s]=n[s]);r.originalType=e,r[d]="string"==typeof e?e:o,i[1]=r;for(var u=2;u<l;u++)i[u]=t[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},1067:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>r,toc:()=>u});var a=t(7462),o=(t(7294),t(3905));const l={sidebar_position:2},i="Stand-up Vanilla",r={unversionedId:"l2-k3s/standup-vanilla",id:"l2-k3s/standup-vanilla",title:"Stand-up Vanilla",description:"Now, finally, Kubernetes.",source:"@site/docs/l2-k3s/standup-vanilla.md",sourceDirName:"l2-k3s",slug:"/l2-k3s/standup-vanilla",permalink:"/hab-guide/docs/l2-k3s/standup-vanilla",draft:!1,editUrl:"https://github.com/GildedPleb/hab-guide/edit/master/docs/l2-k3s/standup-vanilla.md",tags:[],version:"current",lastUpdatedBy:"GildedPleb",lastUpdatedAt:1674880125,formattedLastUpdatedAt:"Jan 28, 2023",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"tutorialSidebar",previous:{title:"Control Prep",permalink:"/hab-guide/docs/l2-k3s/control-prep"},next:{title:"Tear-down Vanilla",permalink:"/hab-guide/docs/l2-k3s/teardown-vanilla"}},s={},u=[{value:"K3s",id:"k3s",level:2},{value:"Confirm Everything is in Running Order",id:"confirm-everything-is-in-running-order",level:2},{value:"Add New Vanilla Hosts",id:"add-new-vanilla-hosts",level:2}],p={toc:u};function d(e){let{components:n,...t}=e;return(0,o.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"stand-up-vanilla"},"Stand-up Vanilla"),(0,o.kt)("p",null,"Now, finally, Kubernetes."),(0,o.kt)("h2",{id:"k3s"},"K3s"),(0,o.kt)("p",null,"Let's inspect ",(0,o.kt)("inlineCode",{parentName:"p"},"K3s/standup-vanilla.yml"),":"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The first thing we will do is a get a script from ",(0,o.kt)("inlineCode",{parentName:"li"},"https://get.k3s.io/")," that\ninstalls K3s, from the official k3s distribution source. If you would like to\nview that script, and you should, open up the link in a web browser. Or with:",(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cat ~/.HAB/remote_content/k3s_install.sh\n"))),(0,o.kt)("li",{parentName:"ol"},"We are also going to get some roll based permissions and a cloud controller\nfor ",(0,o.kt)("inlineCode",{parentName:"li"},"kube-vip"),", and define some resources for MetalLB.\n",(0,o.kt)("a",{parentName:"li",href:"https://kube-vip.io/"},"Kube-vip"),' allows us to use a virtual IP address (vip)\non our network. This means kubectl will still work if one of the master nodes\nis destroyed: in a process called load balancing the control plane. We can\nalso use kube-vip to load balance other services, but it\'s just not a mature\nenough project to rely on it heavily. Load balancing is essentially a HA\nprocess that says "Hey, you are making a request, and we see that it can be\nserviced here, as opposed to here, so we will forward you there."'),(0,o.kt)("li",{parentName:"ol"},"Then we are going to create and save a server token which is used by our\nhosts to identify and join the cluster."),(0,o.kt)("li",{parentName:"ol"},"Install k3s using the token on our Leader and install kube-vip, followed by\nLieutenants, followed by Workers.",(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"Of note, the ",(0,o.kt)("inlineCode",{parentName:"li"},"Pull kube-vip image")," command is creating a manifest\ndefinition (which can be inspected at ",(0,o.kt)("inlineCode",{parentName:"li"},"/tmp/kube-vip.yaml")," on the leader)\nfor kube-vip. This is an atypical way to generate and install manifests,\nbut works well in the kube-vip ecosystem to generate a dynamic manifest,\nAnsible could do the same thing, and may in the future of this guide."),(0,o.kt)("li",{parentName:"ol"},"We will also be copying ",(0,o.kt)("inlineCode",{parentName:"li"},"vault-node-token")," generated by the leader so that\nwe can get other hosts to join the cluster."))),(0,o.kt)("li",{parentName:"ol"},'Once the worker hosts are ready, we will add "worker" role to worker nodes,\nand transfer the cluster credentials to the control computer giving us access\nto the cluster.'),(0,o.kt)("li",{parentName:"ol"},"Lastly, we will install MetalLB as our load balancer. Kube-vip can act as a\nload balancer, but it lacks the features we need, like easy integration with\nNGINX to deploy websites.")),(0,o.kt)("p",null,"Before we can run the command, we must also, finally,\n",(0,o.kt)("a",{parentName:"p",href:"/docs/l1-hosts/networking#designate-ip-address-block"},"hearken back")," to the set\nof IPs we assigned (be it on paper or actually in our router) to the Kubernetes\ncluster, which have thus far been unused."),(0,o.kt)("p",null,"Choose one of those IPs. That will be assigned to the control-plane as the\n",(0,o.kt)("inlineCode",{parentName:"p"},"vip"),". It will be the IP that kubectl looks to connect to. The rest will be the\nblock of IP that MetalLB will be able to assign to various other things,\n",(0,o.kt)("inlineCode",{parentName:"p"},"serviceRange"),". Make sure that the ",(0,o.kt)("inlineCode",{parentName:"p"},"vip")," address is not in the ",(0,o.kt)("inlineCode",{parentName:"p"},"serviceRange"),"\nset. Also, make sure these are codified as ranges."),(0,o.kt)("p",null,"The final command, for us, looks like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"apb K3s/standup-vanilla.yml -e 'vip=10.1.0.50 serviceRange=10.1.0.51-10.1.0.99'\n")),(0,o.kt)("p",null,"If you are comfortable with what it's expected to do, go ahead and run it now."),(0,o.kt)("p",null,"It may take a 5 to 20 minutes, so stand up and walk around."),(0,o.kt)("h2",{id:"confirm-everything-is-in-running-order"},"Confirm Everything is in Running Order"),(0,o.kt)("p",null,"To confirm that everything is up and running, on your control machine run:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get nodes -o wide\n")),(0,o.kt)("p",null,"And you should see something like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"% kubectl get nodes -o wide\nNAME   STATUS   ROLES                       AGE     VERSION        INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                         KERNEL-VERSION      CONTAINER-RUNTIME\nnuc1   Ready    control-plane,etcd,master   6h12m   v1.26.0+k3s2   10.1.0.30     <none>        Ubuntu 22.04.1 LTS               5.15.0-58-generic   containerd://1.6.14-k3s1\nnuc2   Ready    worker                      6h9m    v1.26.0+k3s2   10.1.0.31     <none>        Ubuntu 22.04.1 LTS               5.15.0-58-generic   containerd://1.6.14-k3s1\npi1    Ready    control-plane,etcd,master   6h9m    v1.26.0+k3s2   10.1.0.20     <none>        Debian GNU/Linux 11 (bullseye)   5.15.84-v8+         containerd://1.6.14-k3s1\npi2    Ready    control-plane,etcd,master   6h10m   v1.26.0+k3s2   10.1.0.21     <none>        Debian GNU/Linux 11 (bullseye)   5.15.84-v8+         containerd://1.6.14-k3s1\npi3    Ready    worker                      6h8m    v1.26.0+k3s2   10.1.0.22     <none>        Debian GNU/Linux 11 (bullseye)   5.15.84-v8+         containerd://1.6.14-k3s1\npi4    Ready    worker                      6h5m    v1.26.0+k3s2   10.1.0.23     <none>        Debian GNU/Linux 11 (bullseye)   5.15.84-v8+         containerd://1.6.14-k3s1\npi5    Ready    worker                      6h7m    v1.26.0+k3s2   10.1.0.24     <none>        Debian GNU/Linux 11 (bullseye)   5.15.84-v8+         containerd://1.6.14-k3s1\n\n")),(0,o.kt)("p",null,"All the nodes there? We hope so! But reach out if not."),(0,o.kt)("p",null,"Now, let's make sure that kube-vip was set up correctly as well."),(0,o.kt)("p",null,"Change the namespace to the low level ",(0,o.kt)("inlineCode",{parentName:"p"},"kube-system")," namespace:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'% kubectl ns kube-system\nContext "default" modified.\nActive namespace is "kube-system".\n')),(0,o.kt)("p",null,"And view all the pods running in there (You can think of these pods as system\nprocesses on your computer):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"% kubectl get pods -o wide\nNAME                                      READY   STATUS    RESTARTS   AGE     IP          NODE   NOMINATED NODE   READINESS GATES\ncoredns-5c6b6c5476-ww5lk                  1/1     Running   0          4h18m   10.42.0.3   nuc1   <none>           <none>\nkube-vip-cloud-provider-5459795b8-9q55f   1/1     Running   0          4h18m   10.42.0.5   nuc1   <none>           <none>\nkube-vip-ds-9fc7g                         1/1     Running   0          4h13m   10.1.0.21   pi2    <none>           <none>\nkube-vip-ds-csl6d                         1/1     Running   0          4h16m   10.1.0.20   pi1    <none>           <none>\nkube-vip-ds-tchnq                         1/1     Running   0          4h18m   10.1.0.30   nuc1   <none>           <none>\nlocal-path-provisioner-5d56847996-jrdbc   1/1     Running   0          4h18m   10.42.0.4   nuc1   <none>           <none>\nmetrics-server-7b67f64457-6l5tj           1/1     Running   0          4h18m   10.42.0.2   nuc1   <none>           <none>\n")),(0,o.kt)("p",null,"In particular, pay attention to the ",(0,o.kt)("inlineCode",{parentName:"p"},"kube-vip-ds")," pods, they should be running,\n",(0,o.kt)("inlineCode",{parentName:"p"},"READY 1/1"),", with 1 each on each control-plane host. These Pods run containers,\nwhich run images, and each image makes sure the node is up. To test it, you can\nkill one of the nodes, and still run the ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl get pods")," command. This works\nbecause kubectl is not pointing to a single host, but to a virtual IP in the\ncluster that resolves to a host only if that host is available as determined by\nkube-vip."),(0,o.kt)("p",null,"You can also inspect the MetalLB namespace, and confirm that it is healthy:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'% kubectl ns metallb-system\nContext "default" modified.\nActive namespace is "metallb-system".\n% kubectl get pods -o wide\nNAME                          READY   STATUS    RESTARTS   AGE     IP          NODE   NOMINATED NODE   READINESS GATES\ncontroller-577b5bdfcc-2fbwr   1/1     Running   0          4h29m   10.42.5.2   nuc2   <none>           <none>\nspeaker-2tnp7                 1/1     Running   0          4h29m   10.1.0.30   nuc1   <none>           <none>\nspeaker-4xlrf                 1/1     Running   0          4h29m   10.1.0.23   pi4    <none>           <none>\nspeaker-bqdkf                 1/1     Running   0          4h29m   10.1.0.21   pi2    <none>           <none>\nspeaker-cgfn5                 1/1     Running   0          4h29m   10.1.0.22   pi3    <none>           <none>\nspeaker-d2q86                 1/1     Running   0          4h29m   10.1.0.24   pi5    <none>           <none>\nspeaker-lfmc8                 1/1     Running   0          4h29m   10.1.0.20   pi1    <none>           <none>\nspeaker-wzbwl                 1/1     Running   0          4h29m   10.1.0.31   nuc2   <none>           <none>\n01/20/23-22:05:16 ~/Desktop/HAB git(HAB)(master) \u2388 metallb-system\n')),(0,o.kt)("p",null,"You will notice that there is a speaker pod on each host. These pods also report\nthe availability of the host but do so for the purpose of routing app traffic,\nnot ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl")," traffic."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The ",(0,o.kt)("inlineCode",{parentName:"p"},"-o")," flag is for output, and it is being passed the ",(0,o.kt)("inlineCode",{parentName:"p"},"wide")," argument, without\nthis flag, we don't get as much data as is available to us.")),(0,o.kt)("p",null,"There are two other useful commands to be aware of at this stage:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl describe pod kube-vip-ds-9fc7g\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl logs kube-vip-ds-9fc7g\n")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"describe")," command will print all the information about the pod. The ",(0,o.kt)("inlineCode",{parentName:"p"},"logs"),"\ncommand will print all the logs produced by the pod."),(0,o.kt)("p",null,"These have proven to be immensely helpful when troubleshooting a problem."),(0,o.kt)("p",null,"If everything is looking good, you are now the proud owner of a Kubernetes\nCluster\u2014Yet another Pleb ",(0,o.kt)("em",{parentName:"p"},"is")," the server farm now."),(0,o.kt)("h2",{id:"add-new-vanilla-hosts"},"Add New Vanilla Hosts"),(0,o.kt)("p",null,"If needed, we now have the ability to bring a new vanilla host into the cluster,\nwhich has been added to the host plan, with a one-liner command, without tearing\ndown or setting up anything but that host:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"apb Hosts/standup-live.yml -e \"plan=host-plan-2022-03-17\" && apb K3s/standup-vanilla.yml -e 'vip=10.1.0.50 serviceRange=10.1.0.51-10.1.0.99'\n")),(0,o.kt)("p",null,"Now that we are up and running as a vanilla Kubernetes provider, let's\ninvestigate how to tear it down."))}d.isMDXComponent=!0}}]);